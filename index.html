<!DOCTYPE html>
<html>
<head>
  <title>Public Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    body { margin:0; font-family: Arial; background:#111; color:white; }
    #map { height:100vh; display:none; }

    .login-box {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:#222;
      padding:20px;
      border-radius:10px;
      text-align:center;
    }

    input, button {
      padding:8px;
      margin:5px;
      border:none;
      border-radius:5px;
    }

    button {
      cursor:pointer;
      background:green;
      color:white;
    }

    .top-panel {
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.7);
      padding:8px 15px;
      border-radius:20px;
      z-index:1000;
      display:none;
    }

    .user-list {
      position:absolute;
      right:10px;
      top:60px;
      background:rgba(0,0,0,0.8);
      padding:10px;
      border-radius:10px;
      max-height:300px;
      overflow:auto;
      z-index:1000;
      display:none;
    }
  </style>
</head>
<body>

<div class="login-box" id="loginBox">
  <h2>Enter Name to Join üåç</h2>
  <input type="text" id="username" placeholder="Your name">
  <br>
  <button onclick="start()">Continue</button>
</div>

<div class="top-panel" id="topPanel">
  Active Users: <span id="userCount">0</span>
</div>

<div class="user-list" id="userList"></div>
<div id="map"></div>

<script>
  // üî• PASTE YOUR FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let map;
  let userId;
  let userName;
  let markers = {};
  let watchId;

  const emojis = ["üòé","üî•","üöÄ","üéØ","üëë","üß†","üê±","üêº","ü¶ä","üê∏"];

  function start() {
    userName = document.getElementById("username").value.trim();
    if (!userName) return alert("Enter name");

    userId = "user_" + Math.random().toString(36).substring(2,9);
    const avatar = emojis[Math.floor(Math.random() * emojis.length)];

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("map").style.display = "block";
    document.getElementById("topPanel").style.display = "block";
    document.getElementById("userList").style.display = "block";

    map = L.map('map').setView([20, 78], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    if (navigator.geolocation) {
      watchId = navigator.geolocation.watchPosition(position => {
        const { latitude, longitude } = position.coords;

        db.ref("locations/" + userId).set({
          name: userName,
          avatar: avatar,
          lat: latitude,
          lng: longitude,
          updated: Date.now()
        });

        map.setView([latitude, longitude], 13);
      }, null, { enableHighAccuracy:true });
    }

    // Listen for all users
    db.ref("locations").on("value", snapshot => {
      const users = snapshot.val();
      if (!users) return;

      const userListDiv = document.getElementById("userList");
      userListDiv.innerHTML = "";
      document.getElementById("userCount").innerText = Object.keys(users).length;

      Object.keys(users).forEach(id => {
        const u = users[id];

        // Update sidebar list
        userListDiv.innerHTML += `<div>${u.avatar} ${u.name}</div>`;

        // Custom icon
        const icon = L.divIcon({
          html: `<div style="font-size:24px">${u.avatar}</div>`,
          className: ""
        });

        if (markers[id]) {
          markers[id].setLatLng([u.lat, u.lng]);
        } else {
          markers[id] = L.marker([u.lat, u.lng], { icon })
            .addTo(map)
            .bindPopup(`${u.avatar} ${u.name}`);
        }
      });
    });

    window.addEventListener("beforeunload", () => {
      db.ref("locations/" + userId).remove();
    });
  }
</script>

</body>
</html>
